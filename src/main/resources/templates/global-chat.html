<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head lang="en">
    <meta charset="UTF-8"/>
    <title>Acebook - Global Chat</title>
    <link rel="stylesheet" href="/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col" data-theme="light">

<div sec:authorize="isAuthenticated()" class="navbar-sticky bg-white shadow-lg border-b border-gray-200 z-50 relative flex-none">
    <div class="navbar w-full max-w-7xl mx-auto px-4">
        <div class="navbar-start">
            <a href="/posts" class="btn btn-ghost text-2xl font-extrabold text-blue-600 mr-4">AceBook</a>
        </div>
        <div class="navbar-center flex flex-grow justify-center lg:flex-none">
            <a href="/chat" class="btn btn-ghost btn-sm">Private Chat</a>
            <a href="/global" class="btn btn-primary btn-sm rounded-full">Global Chat</a>
        </div>
        <div class="navbar-end space-x-2">
            <span class="hidden md:inline-block text-sm text-gray-500 mr-2">
                 Hi, <span th:text="${myUsername}">User</span>
            </span>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div class="w-10 rounded-full ring ring-gray-300">
                        <img th:src="@{'https://ui-avatars.com/api/?name=' + ${myUsername} + '&background=random&color=fff'}" alt="Avatar" />
                    </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<main class="flex-grow overflow-hidden pt-6 pb-6 px-4">
    <div class="max-w-7xl mx-auto h-full flex gap-6">

        <div class="w-1/4 hidden md:flex flex-col bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden h-[calc(100vh-8rem)]">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-700">Community Members</h3>
            </div>
            <div class="overflow-y-auto flex-grow">
                <ul class="menu w-full p-2">
                    <li th:each="user : ${users}" th:if="${user.username != myUsername}">
                        <div class="flex items-center gap-3 p-3 rounded-lg cursor-default">
                            <div class="avatar placeholder">
                                <div class="bg-neutral text-neutral-content rounded-full w-8">
                                    <span th:text="${#strings.substring(user.username,0,1).toUpperCase()}">U</span>
                                </div>
                            </div>
                            <span th:text="${user.username}" class="font-medium text-gray-500">User</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="flex-grow bg-white rounded-lg shadow-md border border-gray-200 flex flex-col h-[calc(100vh-8rem)]">

            <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-white rounded-t-lg z-10">
                <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                        <div class="bg-blue-600 text-white rounded-full w-10">
                            <i data-lucide="globe" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div>
                        <h2 class="font-bold text-gray-800">Global Room</h2>
                        <span class="text-xs text-green-500 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span> Live
                        </span>
                    </div>
                </div>
            </div>

            <input type="hidden" id="currentUsername" th:value="${myUsername}" />

            <div id="messageArea" class="flex-grow overflow-y-auto p-6 space-y-4 bg-gray-50">
                <div th:each="msg : ${history}"
                     th:class="${msg.sender.username == myUsername} ? 'chat chat-end' : 'chat chat-start'">

                    <div class="chat-header text-xs opacity-50 mb-1"
                         th:text="${msg.sender.username == myUsername} ? 'You' : ${msg.sender.username}">
                        Sender
                    </div>
                    <div class="chat-bubble"
                         th:classappend="${msg.sender.username == myUsername} ? 'chat-bubble-primary' : 'chat-bubble-secondary bg-gray-200 text-gray-800'"
                         th:text="${msg.content}">
                        Content
                    </div>
                    <div class="chat-footer opacity-50 text-[10px] mt-1">
                        <span th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">12:00</span>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-100 bg-white rounded-b-lg">
                <form onsubmit="sendMessage(event)" class="flex gap-2 items-center">
                    <input type="text" id="messageInput"
                           class="input input-bordered w-full rounded-full bg-gray-100 focus:bg-white transition-colors"
                           placeholder="Type a message to everyone..." autocomplete="off" />
                    <button type="submit" class="btn btn-primary btn-circle">
                        <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</main>

<script th:inline="javascript">
    var stompClient = null;
    var messageArea = document.getElementById('messageArea');
    var currentUser = document.getElementById('currentUsername').value;

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            // Subscribe to the Public Topic
            stompClient.subscribe('/topic/public', function (messageOutput) {
                renderMessageBubble(JSON.parse(messageOutput.body));
            });
        }, function(error) {
            console.error("WebSocket error:", error);
        });
    }

    function renderMessageBubble(msg) {
        var senderName = msg.senderName || "Unknown";
        var isMe = (senderName === currentUser);

        var chatDiv = document.createElement('div');
        chatDiv.className = isMe ? 'chat chat-end' : 'chat chat-start';

        var headerDiv = document.createElement('div');
        headerDiv.className = 'chat-header text-xs opacity-50 mb-1';
        headerDiv.innerText = isMe ? 'You' : senderName;

        var bubbleDiv = document.createElement('div');
        bubbleDiv.className = isMe ? 'chat-bubble chat-bubble-primary' : 'chat-bubble chat-bubble-secondary bg-gray-200 text-gray-800';
        bubbleDiv.innerText = msg.content;

        var footerDiv = document.createElement('div');
        footerDiv.className = 'chat-footer opacity-50 text-[10px] mt-1';
        footerDiv.innerText = msg.timestamp ? msg.timestamp.substring(11, 16) : 'Just now';

        chatDiv.appendChild(headerDiv);
        chatDiv.appendChild(bubbleDiv);
        chatDiv.appendChild(footerDiv);

        messageArea.appendChild(chatDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    function sendMessage(event) {
        event.preventDefault();
        var contentInput = document.getElementById('messageInput');
        var content = contentInput.value.trim();

        if (content && stompClient) {
            var payload = { content: content };
            // Send to the Public Handler
            stompClient.send("/app/public-message", {}, JSON.stringify(payload));
            contentInput.value = '';
        }
    }

    lucide.createIcons();
    connect();
    messageArea.scrollTop = messageArea.scrollHeight;
</script>
</body>
</html>