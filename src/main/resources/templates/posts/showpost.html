<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      xmlns:method="http://www.w3.org/1999/xhtml">
<head lang="en">
    <meta charset="UTF-8"/>
    <title>Acebook - Posts</title>
    <link rel="stylesheet" href="/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col" data-theme="light">
<th:block th:replace="fragments/layout :: navbar"></th:block>

<main class="bg-gray-100 flex-grow flex justify-center items-start pt-8 pb-8">

    <div class="w-full max-w-xl space-y-4 relative">

        <div class="absolute -left-16 top-5 hidden lg:block">
            <a th:href="@{/}" class="btn btn-ghost btn-circle text-gray-500 hover:bg-gray-200" title="Back to Posts">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </a>
        </div>

        <div class="card w-full bg-white border border-gray-200 rounded-lg shadow-md overflow-hidden">

            <div class="h-2 bg-gradient-to-r from-blue-500 to-sky-400"></div>

            <div class="card-body p-4">

                <!-- POST HEADER -->
                <div class="flex items-center mb-3">
                    <div class="avatar mr-3">
                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">

                            <!-- LOGGED-IN USER AVATAR -->
                            <img th:if="${loggedInUser?.imagePath != null}"
                                 th:src="${loggedInUser.imagePath}"
                                 class="object-cover w-full h-full"/>

                            <img th:if="${loggedInUser?.imagePath == null and #authentication?.principal?.attributes != null
                                         and #authentication.principal.attributes['picture'] != null}"
                                 th:src="${#authentication.principal.attributes['picture']}"
                                 class="object-cover w-full h-full"/>

                            <img th:if="${loggedInUser?.imagePath == null and (#authentication?.principal?.attributes == null
                                         or #authentication.principal.attributes['picture'] == null)}"
                                 th:src="'https://placehold.co/40x40/4c6ef5/ffffff?text=' +
                                         ${loggedInUser?.username != null ? #strings.substring(loggedInUser.username,0,1) : 'U'}"
                                 alt="My Avatar" />

                        </div>
                    </div>

                    <div>
                        <a th:href="@{/users/{id}(id=${post.user.id})}"
                           th:text="${post.user.username}"
                           class="font-semibold text-gray-900"></a>

                        <p class="text-xs text-gray-500">
                            <span th:text="${#temporals.format(post.createdAt, 'dd MMM yyyy HH:mm')}"></span>
                            <span th:if="${post.editedAt != null}"> (edited)</span>
                        </p>
                    </div>
                </div>

                <!-- POST IMAGE -->
                <div th:if="${post.imagePath != null}" class="mb-3">
                    <img th:src="${post.imagePath}"
                         alt="Post image"
                         class="rounded-lg w-full object-cover max-h-96 border border-gray-200" />
                </div>


                <!-- LIKE SECTION -->
                <div class="border-y py-2 mb-2 flex justify-between items-center">

                    <!-- LIKE / UNLIKE BUTTON -->
                    <div th:with="currentUser=${loggedInUser.email}" style="display:inline-block">

                        <!-- Like button -->
                        <form th:unless="${#lists.contains(post.likes.![user.email], currentUser)}"
                              th:action="@{'/posts/' + ${post.id} + '/likes'}"
                              method="post"
                              style="display:inline">
                            <button type="submit"
                                    class="btn btn-ghost btn-sm text-gray-500 hover:text-blue-500 hover:bg-blue-50">
                                Like
                            </button>
                        </form>

                        <!-- Unlike button -->
                        <form th:if="${#lists.contains(post.likes.![user.email], currentUser)}"
                              th:action="@{'/posts/' + ${post.id} + '/likes/unlike'}"
                              method="post"
                              style="display:inline">
                            <button type="submit"
                                    class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
                                Unlike
                            </button>
                        </form>

                    </div>

                    <!-- LIKE/COMMENT COUNTS -->
                    <div class="text-xs text-gray-500 flex items-center space-x-3">

                        <div class="relative group">
                            <span class="font-medium cursor-pointer"
                                  th:text="${#lists.size(post.likes)} + ' like(s)'"></span>

                            <!-- Hover list of people who liked -->
                            <div th:if="${#lists.size(post.likes) > 0}"
                                 class="absolute left-1/2 -translate-x-1/2 mt-2 w-max
                                        bg-gray-800 text-white text-xs rounded px-2 py-1
                                        opacity-0 group-hover:opacity-100 transition-opacity duration-200
                                        pointer-events-none z-50 shadow-lg">
                                <ul>
                                    <li th:each="like : ${post.likes}"
                                        th:text="${like.user.username}"></li>
                                </ul>
                            </div>
                        </div>

                        <span th:text="${#lists.size(post.comment)} + ' comment(s)'"
                              class="font-medium">0</span>
                    </div>
                </div>


                <!-- COMMENTS LIST -->
                <div th:each="singleComment : ${post.comment}" class="space-y-3">

                    <div class="flex items-start gap-2">
                        <div class="avatar shrink-0">
                            <div class="w-7 h-7 rounded-full bg-yellow-400 overflow-hidden">

                                <!-- 1. User has uploaded image -->
                                <img th:if="${singleComment.user?.imagePath != null}"
                                     th:src="${singleComment.user.imagePath}"
                                     class="object-cover w-full h-full"/>

                                <!-- 2. User is the logged-in user & Auth0 picture exists -->
                                <img th:if="${singleComment.user?.imagePath == null
                 and loggedInUser != null
                 and singleComment.user.id == loggedInUser.id
                 and #authentication?.principal?.attributes != null
                 and #authentication.principal.attributes['picture'] != null}"
                                     th:src="${#authentication.principal.attributes['picture']}"
                                     class="object-cover w-full h-full"/>

                                <!-- 3. Fallback placeholder for everyone else -->
                                <img th:if="${singleComment.user?.imagePath == null
                 and (loggedInUser == null
                      or singleComment.user.id != loggedInUser.id
                      or #authentication?.principal?.attributes == null
                      or #authentication.principal.attributes['picture'] == null)}"
                                     th:src="'https://placehold.co/40x40/4c6ef5/ffffff?text=' +
                 ${singleComment.user?.username != null ?
                 #strings.toUpperCase(#strings.substring(singleComment.user.username,0,2)) : 'U'}"
                                     class="object-cover w-full h-full"/>
                            </div>

                        </div>

                        <div class="bg-gray-100 p-2 rounded-xl text-sm max-w-[85%]">

                            <a th:href="@{/users/{id}(id=${singleComment.user.id})}"
                               th:text="${singleComment.user.username}"
                               class="font-semibold text-gray-900 hover:underline"></a>

                            <p th:text="${singleComment.content}"
                               class="text-gray-700"></p>

                            <p class="text-xs text-gray-500 mt-1">
                                <span th:text="${#temporals.format(singleComment.createdAt, 'dd MMM yyyy HH:mm')}"></span>
                                <span th:if="${singleComment.editedAt != null}">(edited)</span>
                            </p>

                            <!-- COMMENT LIKE / UNLIKE -->
                            <div class="flex items-center gap-3 mt-1">

                                <!-- Like -->
                                <form th:unless="${#lists.contains(singleComment.likes.![user.email], loggedInUser.email)}"
                                      th:action="@{'/comments/' + ${singleComment.id} + '/like'}"
                                      method="post">
                                    <button type="submit"
                                            class="text-xs text-blue-600 hover:underline">
                                        Like
                                    </button>
                                </form>

                                <!-- Unlike -->
                                <form th:if="${#lists.contains(singleComment.likes.![user.email], loggedInUser.email)}"
                                      th:action="@{'/comments/' + ${singleComment.id} + '/unlike'}"
                                      method="post">
                                    <button type="submit"
                                            class="text-xs text-red-600 hover:underline">
                                        Unlike
                                    </button>
                                </form>

                                <span class="text-xs text-gray-500">
                                    <span th:text="${#lists.size(singleComment.likes)}"></span> like(s)
                                </span>
                            </div>

                            <!-- EDIT / DELETE COMMENT -->
                            <div th:if="${singleComment.user.email == loggedInUser.email}"
                                 class="flex items-center gap-1">

                                <a th:href="@{'/posts/' + ${post.id} + '/comments/' + ${singleComment.id} + '/edit'}"
                                   class="btn btn-ghost btn-xs text-gray-500 hover:text-blue-500 hover:bg-blue-50 gap-1">
                                    <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                                </a>

                                <form th:action="@{'/posts/' + ${post.id} + '/comments/' + ${singleComment.id} + '/delete'}"
                                      method="post">
                                    <button type="submit"
                                            class="btn btn-ghost btn-xs text-gray-500 hover:text-red-600 hover:bg-red-50 gap-1"
                                            onclick="return confirm('Are you sure?');">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>


                <!-- COMMENT FORM -->
                <form th:action="@{/posts/{id}/comment(id=${post.id})}" method="POST"
                      class="mt-1.5 flex items-center space-x-2">

                    <div class="avatar">
                        <div class="w-7 h-7 rounded-full bg-gray-400">

                            <!-- Logged-in user's avatar -->
                            <img th:if="${loggedInUser?.imagePath != null}"
                                 th:src="${loggedInUser.imagePath}"
                                 class="object-cover w-full h-full"/>

                            <img th:if="${loggedInUser?.imagePath == null and #authentication?.principal?.attributes != null
                                         and #authentication.principal.attributes['picture'] != null}"
                                 th:src="${#authentication.principal.attributes['picture']}"
                                 class="object-cover w-full h-full"/>

                            <img th:if="${loggedInUser?.imagePath == null and (#authentication?.principal?.attributes == null
                                         or #authentication.principal.attributes['picture'] == null)}"
                                 th:src="'https://placehold.co/40x40/4c6ef5/ffffff?text=' +
                                         ${loggedInUser?.username != null ? #strings.substring(loggedInUser.username,0,1) : 'U'}"
                                 alt="My Avatar" />
                        </div>
                    </div>

                    <div class="input input-sm input-bordered flex items-center gap-2 flex-grow rounded-full bg-gray-100 border-gray-200">
                        <input type="text" name="content"
                               class="grow bg-transparent text-xs"
                               placeholder="Write a comment..." required />

                        <button type="submit"
                                class="btn btn-ghost btn-xs text-blue-500 hover:text-blue-700 p-0 h-full min-h-0">
                            <i data-lucide="send" class="w-3 h-3"></i>
                        </button>
                    </div>
                </form>

            </div>
        </div>

    </div>

</main>

<script>
    lucide.createIcons();
</script>
</body>
</html>
